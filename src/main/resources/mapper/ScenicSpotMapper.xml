<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="aftnos.aftourismserver.admin.mapper.ScenicSpotMapper">

    <resultMap id="ScenicSpotResultMap" type="aftnos.aftourismserver.admin.pojo.ScenicSpot">
        <id property="id" column="id" />
        <result property="name" column="name" />
        <result property="amapId" column="amap_id" />
        <result property="tags" column="tags" />
        <result property="imageUrl" column="image_url" />
        <result property="imageUrls" column="image_urls" />
        <result property="level" column="level" />
        <result property="ticketPrice" column="ticket_price" />
        <result property="address" column="address" />
        <result property="province" column="province" />
        <result property="city" column="city" />
        <result property="district" column="district" />
        <result property="openTime" column="open_time" />
        <result property="intro" column="intro" />
        <result property="phone" column="phone" />
        <result property="website" column="website" />
        <result property="longitude" column="longitude" />
        <result property="latitude" column="latitude" />
        <result property="sort" column="sort" />
        <result property="isDeleted" column="is_deleted" />
        <result property="createTime" column="create_time" />
        <result property="updateTime" column="update_time" />
    </resultMap>

    <sql id="Base_Column_List">
        id, name, amap_id, tags, image_url, image_urls, level, ticket_price, address, province, city, district,
        open_time, intro, phone, website, longitude, latitude, sort, is_deleted, create_time, update_time
    </sql>

    <insert id="insert" parameterType="aftnos.aftourismserver.admin.pojo.ScenicSpot" useGeneratedKeys="true"
            keyProperty="id">
        INSERT INTO t_scenic_spot
        (name, amap_id, tags, image_url, image_urls, level, ticket_price, address, province, city, district, open_time,
         intro, phone, website, longitude, latitude, sort, is_deleted, create_time, update_time)
        VALUES
        (#{name}, #{amapId}, #{tags}, #{imageUrl}, #{imageUrls}, #{level}, #{ticketPrice}, #{address}, #{province},
         #{city}, #{district}, #{openTime}, #{intro}, #{phone}, #{website}, #{longitude}, #{latitude}, #{sort},
         #{isDeleted}, #{createTime}, #{updateTime})
    </insert>

    <update id="update" parameterType="aftnos.aftourismserver.admin.pojo.ScenicSpot">
        UPDATE t_scenic_spot
        <set>
            <if test="name != null">name = #{name},</if>
            <if test="amapId != null">amap_id = #{amapId},</if>
            <if test="tags != null">tags = #{tags},</if>
            <if test="imageUrl != null">image_url = #{imageUrl},</if>
            <if test="imageUrls != null">image_urls = #{imageUrls},</if>
            <if test="level != null">level = #{level},</if>
            <if test="ticketPrice != null">ticket_price = #{ticketPrice},</if>
            <if test="address != null">address = #{address},</if>
            <if test="province != null">province = #{province},</if>
            <if test="city != null">city = #{city},</if>
            <if test="district != null">district = #{district},</if>
            <if test="openTime != null">open_time = #{openTime},</if>
            <if test="intro != null">intro = #{intro},</if>
            <if test="phone != null">phone = #{phone},</if>
            <if test="website != null">website = #{website},</if>
            <if test="longitude != null">longitude = #{longitude},</if>
            <if test="latitude != null">latitude = #{latitude},</if>
            <if test="sort != null">sort = #{sort},</if>
            update_time = #{updateTime}
        </set>
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <select id="selectById" resultMap="ScenicSpotResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM t_scenic_spot
        WHERE id = #{id} AND is_deleted = 0
    </select>

    <select id="pageList" parameterType="aftnos.aftourismserver.admin.dto.ScenicSpotPageQuery"
            resultType="aftnos.aftourismserver.admin.vo.ScenicSpotVO">
        SELECT
        id,
        name,
        amap_id AS amapId,
        tags,
        image_url AS imageUrl,
        image_urls AS imageUrls,
        level,
        ticket_price AS ticketPrice,
        address,
        province,
        city,
        district,
        open_time AS openTime,
        intro,
        phone,
        website,
        longitude,
        latitude,
        sort,
        create_time AS createTime,
        update_time AS updateTime
        FROM t_scenic_spot
        <where>
            is_deleted = 0
            <if test="name != null and name != ''">
                AND name LIKE CONCAT('%', #{name}, '%')
            </if>
            <if test="address != null and address != ''">
                AND address LIKE CONCAT('%', #{address}, '%')
            </if>
            <if test="level != null and level != ''">
                AND level = #{level}
            </if>
            <if test="tags != null and tags != ''">
                AND tags LIKE CONCAT('%', #{tags}, '%')
            </if>
            <if test="province != null and province != ''">
                AND province = #{province}
            </if>
            <if test="city != null and city != ''">
                AND city = #{city}
            </if>
            <if test="district != null and district != ''">
                AND district = #{district}
            </if>
        </where>
        ORDER BY sort DESC, update_time DESC
    </select>

    <update id="logicalDelete">
        UPDATE t_scenic_spot
        SET is_deleted = 1,
            update_time = #{updateTime}
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <select id="selectDetail" resultType="aftnos.aftourismserver.admin.vo.ScenicSpotVO">
        SELECT
        id,
        name,
        amap_id AS amapId,
        tags,
        image_url AS imageUrl,
        image_urls AS imageUrls,
        level,
        ticket_price AS ticketPrice,
        address,
        province,
        city,
        district,
        open_time AS openTime,
        intro,
        phone,
        website,
        longitude,
        latitude,
        sort,
        create_time AS createTime,
        update_time AS updateTime
        FROM t_scenic_spot
        WHERE id = #{id} AND is_deleted = 0
    </select>

    <select id="portalPageList" parameterType="aftnos.aftourismserver.portal.dto.ScenicSpotPortalPageQuery"
            resultType="aftnos.aftourismserver.portal.vo.ScenicSpotSummaryVO">
        SELECT
        id,
        name,
        tags,
        image_url AS imageUrl,
        level,
        ticket_price AS ticketPrice,
        address,
        province,
        city,
        district,
        open_time AS openTime,
        phone,
        longitude,
        latitude,
        sort
        FROM t_scenic_spot
        <where>
            is_deleted = 0
            <if test="name != null and name != ''">
                AND name LIKE CONCAT('%', #{name}, '%')
            </if>
            <if test="address != null and address != ''">
                AND address LIKE CONCAT('%', #{address}, '%')
            </if>
            <if test="tags != null and tags != ''">
                AND tags LIKE CONCAT('%', #{tags}, '%')
            </if>
            <if test="province != null and province != ''">
                AND province = #{province}
            </if>
            <if test="city != null and city != ''">
                AND city = #{city}
            </if>
            <if test="district != null and district != ''">
                AND district = #{district}
            </if>
        </where>
        ORDER BY sort DESC, update_time DESC
    </select>

    <select id="portalDetail" resultType="aftnos.aftourismserver.portal.vo.ScenicSpotDetailVO">
        SELECT
        id,
        name,
        amap_id AS amapId,
        tags,
        image_url AS imageUrl,
        image_urls AS imageUrls,
        level,
        ticket_price AS ticketPrice,
        address,
        province,
        city,
        district,
        open_time AS openTime,
        intro,
        phone,
        website,
        longitude,
        latitude,
        sort,
        view_count AS viewCount,
        create_time AS createTime,
        update_time AS updateTime
        FROM t_scenic_spot
        WHERE id = #{id} AND is_deleted = 0
    </select>

    <update id="incrementViewCount">
        UPDATE t_scenic_spot
        SET view_count = view_count + 1,
            update_time = #{updateTime}
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <select id="selectByIds" resultMap="ScenicSpotResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM t_scenic_spot
        WHERE is_deleted = 0
          AND id IN
          <foreach collection="ids" item="id" open="(" separator="," close=")">
              #{id}
          </foreach>
    </select>

    <select id="selectDeletedList" resultType="aftnos.aftourismserver.admin.vo.RecycleItemVO">
        SELECT
        id,
        name AS title,
        update_time AS deletedTime,
        NULL AS operator,
        CONCAT('地址：', COALESCE(address, '未维护')) AS extraInfo
        FROM t_scenic_spot
        WHERE is_deleted = 1
        <if test="keyword != null and keyword != ''">
            AND name LIKE CONCAT('%', #{keyword}, '%')
        </if>
        <if test="startTime != null">
            AND update_time &gt;= #{startTime}
        </if>
        <if test="endTime != null">
            AND update_time &lt;= #{endTime}
        </if>
        ORDER BY update_time DESC
    </select>

    <update id="restoreById">
        UPDATE t_scenic_spot
        SET is_deleted = 0,
            update_time = #{updateTime}
        WHERE id = #{id}
          AND is_deleted = 1
    </update>

    <delete id="forceDeleteById">
        DELETE
        FROM t_scenic_spot
        WHERE id = #{id}
          AND is_deleted = 1
    </delete>

    <!-- 动态 SQL 示例：使用 <where> 和 <if> 根据名称、地址可选过滤 -->
</mapper>
