<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="aftnos.aftourismserver.admin.mapper.NewsMapper">

    <resultMap id="NewsResultMap" type="aftnos.aftourismserver.admin.pojo.News">
        <id property="id" column="id" />
        <result property="title" column="title" />
        <result property="content" column="content" />
        <result property="coverUrl" column="cover_url" />
        <result property="author" column="author" />
        <result property="status" column="status" />
        <result property="publishTime" column="publish_time" />
        <result property="viewCount" column="view_count" />
        <result property="isDeleted" column="is_deleted" />
        <result property="createTime" column="create_time" />
        <result property="updateTime" column="update_time" />
    </resultMap>

    <sql id="Base_Column_List">
        id, title, content, cover_url, author, status, publish_time, view_count, is_deleted, create_time, update_time
    </sql>

    <insert id="insert" parameterType="aftnos.aftourismserver.admin.pojo.News" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO t_news
        (title, content, cover_url, author, status, publish_time, view_count, is_deleted, create_time, update_time)
        VALUES
        (#{title}, #{content}, #{coverUrl}, #{author}, #{status}, #{publishTime}, #{viewCount}, #{isDeleted}, #{createTime}, #{updateTime})
    </insert>

    <update id="update" parameterType="aftnos.aftourismserver.admin.pojo.News">
        UPDATE t_news
        <set>
            <if test="title != null">title = #{title},</if>
            <if test="content != null">content = #{content},</if>
            <if test="coverUrl != null">cover_url = #{coverUrl},</if>
            <if test="author != null">author = #{author},</if>
            <if test="status != null">status = #{status},</if>
            <if test="publishTime != null">publish_time = #{publishTime},</if>
            <if test="viewCount != null">view_count = #{viewCount},</if>
            update_time = #{updateTime}
        </set>
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <select id="selectById" resultMap="NewsResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM t_news
        WHERE id = #{id} AND is_deleted = 0
    </select>

    <select id="pageList" parameterType="aftnos.aftourismserver.admin.dto.NewsPageQuery"
            resultType="aftnos.aftourismserver.admin.vo.NewsVO">
        SELECT
        id,
        title,
        content,
        cover_url AS coverUrl,
        author,
        status,
        CASE status
            WHEN 0 THEN '已下线'
            WHEN 1 THEN '已发布'
            ELSE '未知状态'
        END AS statusText,
        publish_time AS publishTime,
        view_count AS viewCount,
        create_time AS createTime,
        update_time AS updateTime
        FROM t_news
        WHERE is_deleted = 0
        <if test="title != null and title != ''">
            AND title LIKE CONCAT('%', #{title}, '%')
        </if>
        <if test="status != null">
            AND status = #{status}
        </if>
        ORDER BY update_time DESC
    </select>

    <update id="logicalDelete">
        UPDATE t_news
        SET is_deleted = 1,
            update_time = #{updateTime}
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <select id="portalPageList" parameterType="aftnos.aftourismserver.portal.dto.NewsPortalPageQuery"
            resultType="aftnos.aftourismserver.portal.vo.NewsPortalVO">
        SELECT
        id,
        title,
        CASE
            WHEN content IS NULL THEN NULL
            WHEN CHAR_LENGTH(content) &gt; 120 THEN CONCAT(SUBSTRING(content, 1, 120), '...')
            ELSE content
        END AS summary,
        cover_url AS coverUrl,
        publish_time AS publishTime,
        author,
        view_count AS viewCount
        FROM t_news
        WHERE is_deleted = 0
          AND status = 1
        <if test="keyword != null and keyword != ''">
            AND title LIKE CONCAT('%', #{keyword}, '%')
        </if>
        ORDER BY COALESCE(publish_time, update_time) DESC, update_time DESC
    </select>

    <select id="portalDetail" resultType="aftnos.aftourismserver.portal.vo.NewsPortalVO">
        SELECT
        id,
        title,
        content,
        CASE
            WHEN content IS NULL THEN NULL
            WHEN CHAR_LENGTH(content) &gt; 120 THEN CONCAT(SUBSTRING(content, 1, 120), '...')
            ELSE content
        END AS summary,
        cover_url AS coverUrl,
        publish_time AS publishTime,
        author,
        view_count AS viewCount
        FROM t_news
        WHERE id = #{id}
          AND is_deleted = 0
          AND status = 1
    </select>

    <update id="incrementViewCount">
        UPDATE t_news
        SET view_count = view_count + 1,
            update_time = #{updateTime}
        WHERE id = #{id}
          AND is_deleted = 0
          AND status = 1
    </update>

    <select id="selectDeletedList" resultType="aftnos.aftourismserver.admin.vo.RecycleItemVO">
        SELECT
        id,
        title,
        update_time AS deletedTime,
        NULL AS operator,
        CONCAT('作者：', COALESCE(author, '未知')) AS extraInfo
        FROM t_news
        WHERE is_deleted = 1
        <if test="keyword != null and keyword != ''">
            AND title LIKE CONCAT('%', #{keyword}, '%')
        </if>
        <if test="startTime != null">
            AND update_time &gt;= #{startTime}
        </if>
        <if test="endTime != null">
            AND update_time &lt;= #{endTime}
        </if>
        ORDER BY update_time DESC
    </select>

    <update id="restoreById">
        UPDATE t_news
        SET is_deleted = 0,
            update_time = #{updateTime}
        WHERE id = #{id}
          AND is_deleted = 1
    </update>

    <delete id="forceDeleteById">
        DELETE
        FROM t_news
        WHERE id = #{id}
          AND is_deleted = 1
    </delete>

    <!-- 分页 SQL 片段示例：
    SELECT ... FROM t_news WHERE is_deleted = 0 ORDER BY update_time DESC
    -->
</mapper>
